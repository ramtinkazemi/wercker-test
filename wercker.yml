box:
  id: quay.io/cashrewards/php-base-ms
  username: $QUAYIO_USERNAME
  password: $QUAYIO_PASSWORD
  tag: mssql
  registry: https://quay.io

dev:
  steps:
    - script:
        name: test
        code: |
          pwd
          ls -al $WERCKER_SOURCE_DIR

    - script:
        name: copy source code
        code: |
           cp -Rp $WERCKER_SOURCE_DIR/src/* /var/www/html
#    - script:
#        name: update dependencies
#        code: |
#          export COMPOSER_ALLOW_SUPERUSER=1
#          composer update --no-interaction --working-dir=/var/www/html
    - script:
        name: set permission
        code: |
           chown -R :www-data /var/www/html

#    - script:
#        name: "Wait for mySQL connection"
#        code: |
#            bash
#            while ! nc -q 1 $MYSQL_PORT_3306_TCP_ADDR $MYSQL_PORT_3306_TCP_PORT
#            </dev/null; do sleep 3; done

    - internal/shell:
        cmd: /bin/bash


build:
  steps:

    - script:
        name: test
        code: |
          echo "Testing ..."


deploy-to-ecs-task-definition:
  box: quay.io/steven_rho/aws-cli
  #box: python:3-slim
  steps:
    ### Task definition for sending metrics to geckoboard
    - steven-rho/aws-ecs-task-definition@0.0.1:
        name: Setup Task Definition (ramtin-test)
        key: $STEP_AWS_ACCESS_KEY_ID
        secret: $STEP_AWS_SECRET_ACCESS_KEY
        region: $STEP_AWS_DEFAULT_REGION
        task-definition-name: ramtin-test
        container-memory: 128
        container_command: "[\"/usr/local/bin/php\", \"/var/www/html/public/index.php\"]"
        task_definition_template: wercker/task_definition/task_definition.json.nonginx.template


deploy-to-ecs-scheduled-task:
  box: quay.io/steven_rho/aws-cli
  steps:

    #####
    # Scheduled task: every 1 minutes
    #####
    - steven-rho/aws-ecs-scheduled-task@0.0.4:
       name: daily-every-2-minutes-ramtin-test
       key: $STEP_AWS_ACCESS_KEY_ID
       secret: $STEP_AWS_SECRET_ACCESS_KEY
       region: $STEP_AWS_DEFAULT_REGION
       schedule-rule-name: daily-every-2-minutes-ramtin-test
       schedule-expression: "rate(2 minute)"
       schedule-state: $STEP_SCHEDULE_STATE
       schedule-description: "Tasks that need to run every 2 minutes for ramtin-test"
       cluster-name: ${STEP_CLUSTER}
       task-count: 1
       task-definition-name: ramtin-test
       target-id: ramtin-test
       target-template: wercker/scheduled_task/ecs_task_target.json.template
    - steven-rho/aws-ecs-scheduled-task@0.0.4:
       name: daily-every-1-minutes-ramtin-test
       key: $STEP_AWS_ACCESS_KEY_ID
       secret: $STEP_AWS_SECRET_ACCESS_KEY
       region: $STEP_AWS_DEFAULT_REGION
       schedule-rule-name: daily-every-1-minutes-ramtin-test
       schedule-expression: "rate(1 minute)"
       schedule-state: $STEP_SCHEDULE_STATE
       schedule-description: "Tasks that need to run every 1 minutes for ramtin-test"
       cluster-name: ${STEP_CLUSTER}
       task-count: 1
       task-definition-name: ramtin-test
       target-id: ramtin-test
       target-template: wercker/scheduled_task/ecs_task_target.json.template
    